<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Clipscribe AI â€” Groq Whisper</title>
  <style>
    :root { --bg:#0d0d0f;--panel:#1a1a1e;--text:#f0f0f3;--muted:#9aa0aa;--brand:#ff2d55; }
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.5 "Inter",system-ui,sans-serif}
    header{display:flex;justify-content:space-between;align-items:center;padding:12px 20px;background:#111;border-bottom:1px solid #222}
    .brand{font-weight:800;font-size:18px}
    .btn{padding:8px 14px;border-radius:8px;background:var(--brand);border:none;color:#fff;font-weight:600;cursor:pointer;font-size:14px}
    main{display:grid;grid-template-columns:260px 1fr;gap:16px;padding:16px}
    .card{background:var(--panel);border-radius:12px;padding:14px}
    .controls label{font-size:13px;color:var(--muted);margin-top:8px;display:block}
    .controls select,.controls button,.controls input{width:100%;margin-top:4px;padding:8px 10px;border-radius:8px;border:1px solid #333;background:#222;color:#fff}
    .controls .actions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
    .player{position:relative;width:100%;max-width:360px;margin:auto;background:#000;border-radius:12px;overflow:hidden}
    video{width:100%;height:auto;display:block}
    .captions{position:absolute;bottom:6%;width:100%;text-align:center}
    .caption-line{font-size:clamp(16px,4vw,28px);font-weight:800;color:#fff;text-shadow:2px 2px 0 #000,-2px -2px 0 #000,0 0 8px #000}
    .caption-line .em{color:#ffe46b}
    .timeline{margin-top:10px;max-height:120px;overflow-y:auto;font-size:13px}
    .timeline div{margin-bottom:4px;padding:4px 6px;border-radius:6px;background:#2a2a2d}
    pre{font-size:12px;white-space:pre-wrap;color:var(--muted);margin-top:10px}
  </style>
</head>
<body>
  <header>
    <div class="brand">ðŸŽ¬ Clipscribe AI</div>
    <button id="uploadBtn" class="btn">Upload</button>
  </header>

  <main>
    <div class="card controls">
      <label>Groq API Key</label>
      <input id="apiKey" type="password" placeholder="Enter your Groq API key" />

      <input id="file" type="file" accept="video/*" style="display:none" />

      <label>Words per subtitle</label>
      <select id="wordsPer"><option value="1">1</option><option value="3" selected>3</option></select>

      <label>Emphasize every</label>
      <select id="emEvery"><option value="0">None</option><option value="3">3rd</option><option value="5">5th</option></select>

      <div class="actions">
        <button id="go">Generate</button>
        <button id="downloadVTT" disabled>Download VTT</button>
      </div>
      <pre id="log"></pre>
    </div>

    <div class="card">
      <div class="player">
        <video id="video" controls></video>
        <div class="captions"><div class="caption-line" id="caption"></div></div>
      </div>
      <div class="timeline" id="timeline"></div>
    </div>
  </main>

<script>
const apiKeyEl=document.getElementById('apiKey');
const fileEl=document.getElementById('file');
const uploadBtn=document.getElementById('uploadBtn');
const videoEl=document.getElementById('video');
const captionEl=document.getElementById('caption');
const wordsPerEl=document.getElementById('wordsPer');
const emEveryEl=document.getElementById('emEvery');
const goBtn=document.getElementById('go');
const dlBtn=document.getElementById('downloadVTT');
const logEl=document.getElementById('log');
const tlEl=document.getElementById('timeline');

let cues=[],lastURL;

uploadBtn.addEventListener('click',()=>fileEl.click());

function log(m){logEl.textContent+="\\n"+m;}

fileEl.onchange=()=>{const f=fileEl.files?.[0];if(!f)return;if(lastURL)URL.revokeObjectURL(lastURL);lastURL=URL.createObjectURL(f);videoEl.src=lastURL;log('Video loaded.');};

// Call Groq Whisper API
async function transcribeWithGroq(file, apiKey){
  const formData=new FormData();
  formData.append("file",file);
  formData.append("model","whisper-large-v3");

  const resp=await fetch("https://api.groq.com/openai/v1/audio/transcriptions",{
    method:"POST",
    headers:{Authorization:`Bearer ${apiKey}`},
    body:formData
  });

  if(!resp.ok) throw new Error("Groq API error: "+resp.status);
  return await resp.json();
}

function groupWords(words,n){
  const g=[];for(let i=0;i<words.length;i+=n){
    const s=words.slice(i,i+n);
    g.push({text:s.map(w=>w.word).join(' '),start:s[0].start,end:s[s.length-1].end});
  }
  return g;
}

function attachOverlay(groups,every){
  cues=groups;
  videoEl.ontimeupdate=()=>{
    const t=videoEl.currentTime;
    const c=cues.find(x=>t>=x.start&&t<=x.end);
    if(!c){captionEl.innerHTML='';return;}
    if(every>0){
      captionEl.innerHTML=c.text.split(/\\s+/).map((w,i)=>((i+1)%every===0?`<span class='em'>${w}</span>`:w)).join(' ');
    } else captionEl.textContent=c.text;
  }
}

function renderTimeline(groups){
  tlEl.innerHTML='';groups.forEach(g=>{
    const d=document.createElement('div');
    d.textContent=`${g.start.toFixed(1)}s - ${g.end.toFixed(1)}s: ${g.text}`;
    tlEl.appendChild(d);
  });
}

async function generate(){
  const f=fileEl.files?.[0];
  const apiKey=apiKeyEl.value.trim();
  if(!apiKey){alert("Enter Groq API key");return;}
  if(!f){alert('Pick a video');return;}
  goBtn.disabled=true;dlBtn.disabled=true;captionEl.textContent='';log('Sending to Groq...');

  try {
    const data=await transcribeWithGroq(f,apiKey);
    log("Got transcription.");
    // Groq returns segments with start/end
    const allWords=[];
    (data.segments||[]).forEach(seg=>{
      if(seg.words){
        seg.words.forEach(w=>{allWords.push({word:w.word,start:w.start,end:w.end});});
      } else {
        allWords.push({word:seg.text,start:seg.start,end:seg.end});
      }
    });
    const groups=groupWords(allWords,parseInt(wordsPerEl.value));
    attachOverlay(groups,parseInt(emEveryEl.value));
    renderTimeline(groups);

    // Build VTT
    const vtt='WEBVTT\\n\\n'+groups.map((g,i)=>`${i+1}\\n00:00:${g.start.toFixed(3)} --> 00:00:${g.end.toFixed(3)}\\n${g.text}\\n`).join('\\n');
    const blob=new Blob([vtt],{type:'text/vtt'});
    const url=URL.createObjectURL(blob);
    dlBtn.disabled=false;
    dlBtn.onclick=()=>{const a=document.createElement('a');a.href=url;a.download='captions.vtt';a.click();};
    log("âœ… Done!");
  } catch(e){
    log("Error: "+e.message);
  }
  goBtn.disabled=false;
}

goBtn.onclick=()=>generate();
</script>
</body>
</html>
