<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DevPost — Roblox Dev Marketplace</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            base: { 900: '#0a0a0b', 800: '#0f0f12', 700: '#141419' },
          },
          boxShadow: {
            soft: '0 8px 30px rgba(0,0,0,0.35)'
          }
        }
      }
    }
  </script>
  <style>
    .glass { background: rgba(20,20,25,0.6); backdrop-filter: blur(10px); }
    .scrollbar::-webkit-scrollbar{height:8px;width:8px}
    .scrollbar::-webkit-scrollbar-thumb{background:#2a2a33;border-radius:8px}
  </style>
</head>
<body class="bg-base-900 text-white min-h-screen">
  <!-- Nav -->
  <header class="sticky top-0 z-40 border-b border-white/10 bg-base-900/80 backdrop-blur">
    <div class="mx-auto max-w-7xl px-4 py-3 flex items-center gap-3">
      <div class="text-xl font-semibold">DevPost</div>
      <div class="hidden sm:flex items-center gap-2 ml-4 flex-1">
        <input id="searchInput" placeholder="Search services, users…" class="w-full bg-base-800/80 rounded-xl px-4 py-2 outline-none focus:ring-2 ring-white/20" />
        <button id="searchBtn" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20 transition">Search</button>
      </div>
      <div class="ml-auto flex items-center gap-3">
        <button id="newPostBtn" class="px-4 py-2 rounded-xl bg-white text-black font-semibold hover:opacity-90 transition">New Post</button>
        <div id="userAvatar" class="flex items-center gap-2"></div>
      </div>
    </div>
  </header>

  <!-- Hero (mobile search) -->
  <section class="sm:hidden px-4 mt-4">
    <div class="rounded-2xl p-4 bg-base-800/60">
      <h1 class="text-2xl font-bold">Find Roblox Devs. Fast.</h1>
      <div class="mt-3 flex gap-2">
        <input id="mSearchInput" placeholder="Search services, users…" class="flex-1 bg-base-800/80 rounded-xl px-4 py-2 outline-none focus:ring-2 ring-white/20" />
        <button id="mSearchBtn" class="px-3 py-2 rounded-xl bg-white text-black font-semibold">Go</button>
      </div>
    </div>
  </section>

  <!-- Content -->
  <main class="mx-auto max-w-7xl px-4 py-6">
    <!-- Onboarding card -->
    <div id="onboarding" class="hidden rounded-2xl glass border border-white/10 p-6 shadow-soft">
      <h2 class="text-xl font-semibold mb-2">Get started</h2>
      <p class="text-white/70 mb-4">Connect your Gmail and pick a public username. Your profile is saved locally to your browser.</p>
      <div class="grid sm:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm mb-1">Gmail</label>
          <input id="emailInput" type="email" placeholder="you@gmail.com" class="w-full bg-base-800 rounded-xl px-4 py-2 outline-none focus:ring-2 ring-white/20" />
        </div>
        <div>
          <label class="block text-sm mb-1">Username</label>
          <input id="usernameInput" placeholder="@builder" class="w-full bg-base-800 rounded-xl px-4 py-2 outline-none focus:ring-2 ring-white/20" />
        </div>
      </div>
      <div class="mt-4 flex items-center gap-3">
        <button id="saveProfileBtn" class="px-4 py-2 rounded-xl bg-white text-black font-semibold">Save</button>
        <span id="profileStatus" class="text-sm text-white/60"></span>
      </div>
    </div>

    <!-- Create Post modal -->
    <dialog id="postDialog" class="w-full max-w-2xl rounded-2xl bg-base-800 text-white p-0 overflow-hidden">
      <form method="dialog">
        <div class="p-5 border-b border-white/10 flex items-center justify-between">
          <h3 class="text-lg font-semibold">Create a Service Post</h3>
          <button id="closePostDialog" class="text-white/60 hover:text-white">✕</button>
        </div>
      </form>
      <div class="p-5 space-y-4">
        <div>
          <label class="block text-sm mb-1">Service Name</label>
          <input id="postTitle" class="w-full bg-base-700 rounded-xl px-4 py-2 outline-none focus:ring-2 ring-white/20" maxlength="80" />
        </div>
        <div>
          <label class="block text-sm mb-1">Description</label>
          <textarea id="postDesc" class="w-full bg-base-700 rounded-xl px-4 py-2 outline-none focus:ring-2 ring-white/20 min-h-[120px]" maxlength="4000"></textarea>
        </div>
        <div>
          <label class="block text-sm mb-1">Image URLs (min 2)</label>
          <div class="space-y-2" id="imagesList"></div>
          <button id="addImage" class="mt-2 px-3 py-1 rounded-lg bg-white/10 hover:bg-white/20">+ Add image</button>
        </div>
        <div class="grid sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm mb-1">Portfolio (optional)</label>
            <input id="portfolio" placeholder="https://…" class="w-full bg-base-700 rounded-xl px-4 py-2 outline-none focus:ring-2 ring-white/20" />
          </div>
          <div>
            <label class="block text-sm mb-1">Discord Contact</label>
            <input id="contact" placeholder="username#1234 or @handle" class="w-full bg-base-700 rounded-xl px-4 py-2 outline-none focus:ring-2 ring-white/20" />
          </div>
        </div>
        <div>
          <label class="block text-sm mb-1">Other Socials (optional)</label>
          <input id="socialX" placeholder="X/Twitter URL" class="w-full bg-base-700 rounded-xl px-4 py-2 outline-none focus:ring-2 ring-white/20 mb-2" />
          <input id="socialYT" placeholder="YouTube URL" class="w-full bg-base-700 rounded-xl px-4 py-2 outline-none focus:ring-2 ring-white/20 mb-2" />
          <input id="socialGH" placeholder="GitHub URL" class="w-full bg-base-700 rounded-xl px-4 py-2 outline-none focus:ring-2 ring-white/20" />
        </div>
        <div class="flex items-center justify-between gap-3">
          <p class="text-sm text-white/60">New posts go <span class="font-semibold text-white">On Hold</span> until a moderator approves.</p>
          <button id="submitPost" class="px-4 py-2 rounded-xl bg-white text-black font-semibold">Submit</button>
        </div>
        <p id="postError" class="text-sm text-red-400"></p>
      </div>
    </dialog>

    <!-- Feed header -->
    <div class="mt-6 flex items-center justify-between">
      <h2 class="text-lg font-semibold">Top Services</h2>
      <div class="flex items-center gap-2 text-sm">
        <label class="opacity-70">Order</label>
        <select id="orderSelect" class="bg-base-800 rounded-lg px-2 py-1">
          <option value="top">Top</option>
          <option value="new">Newest</option>
        </select>
      </div>
    </div>

    <!-- Feed grid -->
    <div id="feed" class="mt-4 grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>

    <footer class="mt-16 pb-10 text-center text-white/40 text-sm">DevPost • Make cool things • Be kind</footer>
  </main>

  <!-- Moderation Panel (F2) -->
  <dialog id="modDialog" class="w-full max-w-5xl rounded-2xl bg-base-800 text-white p-0 overflow-hidden">
    <div class="p-5 border-b border-white/10 flex items-center justify-between">
      <h3 class="text-lg font-semibold">Moderation Panel</h3>
      <button id="closeModDialog" class="text-white/60 hover:text-white">✕</button>
    </div>
    <div class="p-5 space-y-4">
      <div class="flex items-center gap-2">
        <input id="modCode" placeholder="Access code" class="bg-base-700 rounded-xl px-3 py-2" />
        <button id="modAuthBtn" class="px-3 py-2 rounded-xl bg-white text-black font-semibold">Unlock</button>
      </div>
      <div class="grid md:grid-cols-3 gap-4">
        <section class="md:col-span-2">
          <h4 class="font-semibold mb-2">On Hold Posts</h4>
          <div id="holdList" class="space-y-3"></div>
        </section>
        <aside>
          <h4 class="font-semibold mb-2">Search / Reports</h4>
          <div class="space-y-2">
            <input id="modSearch" placeholder="Search posts or users…" class="w-full bg-base-700 rounded-xl px-3 py-2" />
            <button id="modSearchBtn" class="w-full px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20">Search</button>
          </div>
          <div class="mt-4">
            <h5 class="font-semibold mb-1">Recent Reports</h5>
            <div id="reportList" class="space-y-2"></div>
          </div>
        </aside>
      </div>
    </div>
  </dialog>

  <template id="imageInputTpl">
    <div class="flex items-center gap-2">
      <input placeholder="https://image.url" class="flex-1 bg-base-700 rounded-xl px-3 py-2" />
      <button class="removeImg px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20">✕</button>
    </div>
  </template>

  <script>
    // --- Local profile ---
    const state = {
      profile: JSON.parse(localStorage.getItem('devpost_profile') || 'null'),
      modToken: null,
    };

    const onboarding = document.getElementById('onboarding');
    const userAvatar = document.getElementById('userAvatar');
    const newPostBtn = document.getElementById('newPostBtn');

    function renderProfile() {
      userAvatar.innerHTML = '';
      if (!state.profile) {
        onboarding.classList.remove('hidden');
        userAvatar.innerHTML = `<button class="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/20" id="openOnboarding">Sign in</button>`;
        document.getElementById('openOnboarding').onclick = () => onboarding.scrollIntoView({behavior:'smooth'});
        return;
      }
      onboarding.classList.add('hidden');
      userAvatar.innerHTML = `
        <div class="px-3 py-2 rounded-xl bg-base-800 text-sm">
          <span class="opacity-60">Signed in as</span> <span class="font-semibold">${state.profile.username}</span>
        </div>`;
    }

    document.getElementById('saveProfileBtn').onclick = () => {
      const email = document.getElementById('emailInput').value.trim();
      const username = document.getElementById('usernameInput').value.trim();
      if (!email || !username) { document.getElementById('profileStatus').textContent = 'Email and username required'; return; }
      state.profile = { email, username };
      localStorage.setItem('devpost_profile', JSON.stringify(state.profile));
      document.getElementById('profileStatus').textContent = 'Saved!';
      renderProfile();
    };

    renderProfile();

    // --- Post dialog logic ---
    const postDialog = document.getElementById('postDialog');
    const imagesList = document.getElementById('imagesList');
    const imageTpl = document.getElementById('imageInputTpl');

    function addImageInput(value=''){
      const node = imageTpl.content.cloneNode(true);
      const input = node.querySelector('input');
      input.value = value;
      node.querySelector('.removeImg').onclick = (e) => { e.preventDefault(); e.target.parentElement.remove(); };
      imagesList.appendChild(node);
    }

    document.getElementById('addImage').onclick = (e)=>{ e.preventDefault(); addImageInput(''); };
    addImageInput(''); addImageInput('');

    newPostBtn.onclick = () => {
      if (!state.profile) { onboarding.scrollIntoView({behavior:'smooth'}); return; }
      postDialog.showModal();
    };
    document.getElementById('closePostDialog').onclick = ()=> postDialog.close();

    document.getElementById('submitPost').onclick = async () => {
      const title = document.getElementById('postTitle').value.trim();
      const description = document.getElementById('postDesc').value.trim();
      const portfolio = document.getElementById('portfolio').value.trim();
      const contact = document.getElementById('contact').value.trim();
      const socials = { x: document.getElementById('socialX').value.trim(), youtube: document.getElementById('socialYT').value.trim(), github: document.getElementById('socialGH').value.trim(), discord: contact };
      const images = [...imagesList.querySelectorAll('input')].map(i=>i.value.trim()).filter(Boolean);
      const err = document.getElementById('postError');
      err.textContent='';
      if (images.length < 2) { err.textContent = 'At least 2 images required'; return; }
      if (title.length < 3 || description.length < 20) { err.textContent = 'Please provide a longer title/description'; return; }
      try{
        const res = await fetch('/api/api.js?route=create_post', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({
          author: state.profile, title, description, images, portfolio, socials, contact
        })});
        if (!res.ok) throw new Error(await res.text());
        postDialog.close();
        loadFeed();
        alert('Submitted! Your post is on hold for moderation.');
      }catch(e){ err.textContent = e.message || 'Failed to submit'; }
    };

    // --- Feed render ---
    const feed = document.getElementById('feed');
    const orderSelect = document.getElementById('orderSelect');

    async function loadFeed(q=''){
      const order = orderSelect.value;
      const res = await fetch(`/api/api.js?route=list_posts&q=${encodeURIComponent(q)}&order=${order}`);
      const posts = await res.json();
      feed.innerHTML = '';
      if (!posts.length){ feed.innerHTML = '<div class="text-white/60">No posts yet.</div>'; return; }
      for (const p of posts){
        const card = document.createElement('div');
        card.className = 'rounded-2xl bg-base-800/60 border border-white/10 shadow-soft overflow-hidden hover:-translate-y-0.5 transition transform';
        card.innerHTML = `
          <div class="relative">
            <div class="flex gap-2 overflow-x-auto scrollbar p-2 bg-black/20">
              ${p.images.map(url=>`<img src="${url}" alt="" class="h-40 w-64 object-cover rounded-xl" onerror="this.style.display='none'"/>`).join('')}
            </div>
            <div class="absolute top-2 left-2 px-2 py-1 rounded-lg text-xs ${p.status==='APPROVED'?'bg-green-500/20 text-green-300':'bg-yellow-500/20 text-yellow-300'}">${p.status.replace('_',' ')}</div>
          </div>
          <div class="p-4 space-y-2">
            <div class="flex items-center justify-between gap-2">
              <h3 class="font-semibold text-lg">${p.title}</h3>
              <div class="text-sm opacity-80">⭐ ${p.author.ratingAverage.toFixed(1)} · ${p.author.ratingCount}</div>
            </div>
            <p class="text-white/70 line-clamp-3">${p.description}</p>
            <div class="flex items-center gap-2 text-sm text-white/70 flex-wrap">
              <span>@${p.author.username}</span>
              ${p.portfolio ? `<a href="${p.portfolio}" target="_blank" class="underline">Portfolio</a>`: ''}
              ${p.contact ? `<span>Discord: ${p.contact}</span>`: ''}
            </div>
            <div class="flex items-center gap-2">
              <button class="px-3 py-1.5 rounded-lg bg-white/10 hover:bg-white/20" data-action="rate" data-id="${p.author.id}">Rate</button>
              ${state.profile && state.profile.email === p.author.email ? `<button class="px-3 py-1.5 rounded-lg bg-white/10 hover:bg-white/20" data-action="delete" data-id="${p.id}">Delete</button>`: ''}
              <button class="ml-auto px-3 py-1.5 rounded-lg bg-white/10 hover:bg-white/20" data-action="report" data-id="${p.id}">Report</button>
            </div>
          </div>`;
        card.addEventListener('click', async (e)=>{
          const btn = e.target.closest('button');
          if (!btn) return;
          const action = btn.dataset.action;
          if (action==='delete'){
            if (!confirm('Delete this post?')) return;
            const res = await fetch(`/api/api.js?route=delete_post&id=${btn.dataset.id}`, { method:'DELETE', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ author: state.profile })});
            if (res.ok){ loadFeed(); } else { alert(await res.text()); }
          }
          if (action==='rate'){
            const value = +prompt('Rate this user 1-5');
            if (!value || value<1 || value>5) return;
            await fetch('/api/api.js?route=rate_user', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ from: state.profile, toEmail: p.author.email, value })});
            loadFeed();
          }
          if (action==='report'){
            const reason = prompt('Reason for report?');
            if (!reason) return;
            await fetch('/api/api.js?route=report', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ reporter: state.profile, targetType:'POST', targetId: p.id, reason })});
            alert('Reported. Thanks.');
          }
        });
        feed.appendChild(card);
      }
    }

    loadFeed();

    // search
    const searchInput = document.getElementById('searchInput');
    document.getElementById('searchBtn').onclick = ()=> loadFeed(searchInput.value.trim());
    document.getElementById('mSearchBtn').onclick = ()=> loadFeed(document.getElementById('mSearchInput').value.trim());

    // --- Moderation Panel ---
    const modDialog = document.getElementById('modDialog');
    window.addEventListener('keydown', (e)=>{ if (e.key==='F2'){ modDialog.showModal(); }});
    document.getElementById('closeModDialog').onclick = ()=> modDialog.close();

    document.getElementById('modAuthBtn').onclick = async ()=>{
      const code = document.getElementById('modCode').value.trim();
      if (!code) return;
      state.modToken = code; // naive demo — send as header
      await loadHold();
      await loadReports();
    };

    async function loadHold(){
      const res = await fetch('/api/api.js?route=list_hold', { headers: { 'x-mod-code': state.modToken || '' }});
      if (!res.ok){ document.getElementById('holdList').innerHTML = '<div class="text-red-400 text-sm">Unauthorized</div>'; return; }
      const posts = await res.json();
      const wrap = document.getElementById('holdList');
      wrap.innerHTML = '';
      for (const p of posts){
        const div = document.createElement('div');
        div.className = 'rounded-xl bg-base-900/60 border border-white/10 p-3';
        div.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="font-semibold">${p.title}</div>
            <div class="text-sm opacity-70">@${p.author.username}</div>
          </div>
          <p class="text-white/70 mt-1 line-clamp-2">${p.description}</p>
          <div class="flex gap-2 mt-2 overflow-x-auto scrollbar">${p.images.map(u=>`<img src="${u}" class="h-16 w-24 object-cover rounded-lg">`).join('')}</div>
          <div class="mt-2 flex items-center gap-2">
            <button class="approve px-3 py-1.5 rounded-lg bg-green-500/20">Approve</button>
            <button class="reject px-3 py-1.5 rounded-lg bg-red-500/20">Reject</button>
          </div>`;
        div.querySelector('.approve').onclick = async ()=>{ await moderate(p.id, 'approve'); };
        div.querySelector('.reject').onclick = async ()=>{
          const reason = prompt('Reason?');
          await moderate(p.id, 'reject', reason||'');
        };
        wrap.appendChild(div);
      }
    }

    async function loadReports(){
      const res = await fetch('/api/api.js?route=list_reports', { headers: { 'x-mod-code': state.modToken || '' }});
      const reports = res.ok ? await res.json() : [];
      const wrap = document.getElementById('reportList');
      wrap.innerHTML = reports.map(r=>`<div class="text-sm bg-base-900/60 border border-white/10 rounded-lg p-2">${r.reason} — <span class="opacity-70">${r.targetType}:${r.targetId}</span></div>`).join('');
    }

    async function moderate(id, action, reason=''){
      const res = await fetch(`/api/api.js?route=moderate&id=${id}`, { method:'POST', headers:{ 'Content-Type':'application/json', 'x-mod-code': state.modToken || ''}, body: JSON.stringify({ action, reason })});
      if (!res.ok) { alert(await res.text()); return; }
      await loadHold();
      await loadFeed();
    }
  </script>
</body>
</html>
