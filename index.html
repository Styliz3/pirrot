<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Clipscribe AI â€” Shorts Subtitles</title>
  <link rel="icon" href="data:," />
  <style>
    :root {
      --bg: #0d0d0f;
      --panel: #1a1a1e;
      --text: #f0f0f3;
      --muted: #9aa0aa;
      --brand: #ff2d55;
    }
    body {
      margin:0; background:var(--bg); color:var(--text);
      font:15px/1.5 "Inter", system-ui, sans-serif;
    }
    header {
      display:flex; justify-content:space-between; align-items:center;
      padding:12px 24px; background:#111; border-bottom:1px solid #222;
    }
    .brand { font-weight:800; font-size:18px; }
    .btn {
      padding:8px 14px; border-radius:8px;
      background:var(--brand); border:none; color:#fff;
      font-weight:600; cursor:pointer; font-size:14px;
    }
    main { display:grid; grid-template-columns:280px 1fr; gap:16px; padding:20px; }
    .card {
      background:var(--panel); border-radius:12px; padding:16px;
    }
    .controls label { font-size:13px; color:var(--muted); margin-top:10px; display:block; }
    .controls select, .controls button, .controls input {
      width:100%; margin-top:4px; padding:8px 10px;
      border-radius:8px; border:1px solid #333; background:#222; color:#fff;
    }
    .controls .actions { display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; }
    .player { position:relative; aspect-ratio:9/16; background:#000; border-radius:12px; overflow:hidden; }
    video { width:100%; height:100%; object-fit:contain; }
    .captions { position:absolute; bottom:8%; width:100%; text-align:center; }
    .caption-line {
      font-size:clamp(18px,5vw,36px);
      font-weight:800;
      color:#fff;
      text-shadow: 2px 2px 0 #000, -2px -2px 0 #000, 0 0 8px #000;
    }
    .caption-line .em { color:#ffe46b; }
    .timeline { margin-top:10px; max-height:120px; overflow-y:auto; font-size:13px; }
    .timeline div { margin-bottom:4px; padding:4px 6px; border-radius:6px; background:#2a2a2d; }
    pre { font-size:12px; white-space:pre-wrap; color:var(--muted); margin-top:10px; }
  </style>
  <!-- Transformers.js (UMD build) -->
  <script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.15.0/dist/transformers.umd.min.js"></script>
  <!-- ffmpeg.wasm -->
  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js"></script>
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@800&family=Anton&family=Poppins:wght@700&display=swap" rel="stylesheet">
</head>
<body>
  <header>
    <div class="brand">ðŸŽ¬ Clipscribe AI</div>
    <button class="btn" onclick="fileEl.click()">Upload</button>
  </header>

  <main>
    <div class="card controls">
      <input id="file" type="file" accept="video/*" style="display:none" />
      <label>Words per subtitle</label>
      <select id="wordsPer"><option value="1">1</option><option value="3" selected>3</option></select>

      <label>Emphasize every</label>
      <select id="emEvery"><option value="0">None</option><option value="3">3rd</option><option value="5">5th</option></select>

      <label>Caption font</label>
      <select id="fontFamily">
        <option value="KomikaAxis,Impact,sans-serif">Komika Axis (Meme)</option>
        <option value="'Montserrat',sans-serif">Montserrat Bold</option>
        <option value="'Anton',sans-serif">Anton</option>
        <option value="'Poppins',sans-serif">Poppins (TikTok style)</option>
      </select>

      <div class="actions">
        <button id="go">Generate</button>
        <button id="downloadVTT" disabled>Download VTT</button>
        <button id="export" disabled>Export MP4</button>
      </div>
      <pre id="log"></pre>
    </div>

    <div class="card">
      <div class="player">
        <video id="video" controls></video>
        <div class="captions"><div class="caption-line" id="caption"></div></div>
      </div>
      <div class="timeline" id="timeline"></div>
    </div>
  </main>

<script>
const fileEl=document.getElementById('file'),videoEl=document.getElementById('video'),captionEl=document.getElementById('caption');
const wordsPerEl=document.getElementById('wordsPer'),emEveryEl=document.getElementById('emEvery'),fontEl=document.getElementById('fontFamily');
const goBtn=document.getElementById('go'),dlBtn=document.getElementById('downloadVTT'),expBtn=document.getElementById('export');
const logEl=document.getElementById('log'),tlEl=document.getElementById('timeline');
let cues=[],lastURL;

function log(m){logEl.textContent+="\\n"+m;}

fileEl.onchange=()=>{const f=fileEl.files?.[0];if(!f)return;if(lastURL)URL.revokeObjectURL(lastURL);lastURL=URL.createObjectURL(f);videoEl.src=lastURL;log('Video loaded.');};

async function decodeToMono16k(file){
  const ab=await file.arrayBuffer();const ctx=new AudioContext();const buf=await ctx.decodeAudioData(ab.slice(0));
  const off=new OfflineAudioContext(1,Math.ceil(buf.duration*16000),16000);
  const mono=off.createBuffer(1,buf.length,buf.sampleRate);const ch0=buf.getChannelData(0);
  if(buf.numberOfChannels===1)mono.copyToChannel(ch0,0);else{const ch1=buf.getChannelData(1),m=mono.getChannelData(0);for(let i=0;i<buf.length;i++)m[i]=.5*(ch0[i]+ch1[i]);}
  const src=off.createBufferSource();src.buffer=mono;src.connect(off.destination);src.start();const rendered=await off.startRendering();return rendered.getChannelData(0);
}

function groupWords(words,n){const g=[];for(let i=0;i<words.length;i+=n){const s=words.slice(i,i+n);g.push({text:s.map(w=>w.word).join(' '),start:s[0].start,end:s[s.length-1].end})}return g;}

function attachOverlay(groups,every){
  cues=groups;videoEl.ontimeupdate=()=>{
    const t=videoEl.currentTime;const c=cues.find(x=>t>=x.start&&t<=x.end);
    captionEl.style.fontFamily=fontEl.value;
    if(!c){captionEl.innerHTML='';return;}
    if(every>0){captionEl.innerHTML=c.text.split(/\\s+/).map((w,i)=>((i+1)%every===0?`<span class='em'>${w}</span>`:w)).join(' ');}
    else captionEl.textContent=c.text;
  }
}

function renderTimeline(groups){
  tlEl.innerHTML='';groups.forEach(g=>{
    const d=document.createElement('div');d.textContent=`${g.start.toFixed(1)}s - ${g.end.toFixed(1)}s: ${g.text}`;tlEl.appendChild(d);
  });
}

let asr;
async function ensure(){
  if(asr)return asr;log('Loading model...');const {pipeline}=window.transformers;
  asr=await pipeline('automatic-speech-recognition','Xenova/whisper-tiny.en');log('Model ready.');return asr;
}

async function generate(){
  const f=fileEl.files?.[0];if(!f){alert('Pick a video');return;}
  goBtn.disabled=true;dlBtn.disabled=true;expBtn.disabled=true;captionEl.textContent='';log('Decoding audio...');
  const audio=await decodeToMono16k(f);
  log('Transcribing...');const model=await ensure();
  const out=await model(audio,{chunk_length_s:25,stride_length_s:5,return_timestamps:true});
  const words=[];(out.segments||[]).forEach(s=>(s.words||[]).forEach(w=>{if(w.start!==undefined)words.push({word:w.word.trim(),start:w.start,end:w.end})}));
  if(!words.length){log('No words detected.');return;}
  const groups=groupWords(words,parseInt(wordsPerEl.value));attachOverlay(groups,parseInt(emEveryEl.value));renderTimeline(groups);
  const vtt='WEBVTT\\n\\n'+groups.map((g,i)=>`${i+1}\\n00:00:${g.start.toFixed(3)} --> 00:00:${g.end.toFixed(3)}\\n${g.text}\\n`).join('\\n');
  const blob=new Blob([vtt],{type:'text/vtt'});const url=URL.createObjectURL(blob);
  dlBtn.disabled=false;dlBtn.onclick=()=>{const a=document.createElement('a');a.href=url;a.download='captions.vtt';a.click();};
  expBtn.disabled=false;expBtn.onclick=()=>exportVideo(f,groups);
  log('âœ… Done!');
  goBtn.disabled=false;
}

goBtn.onclick=()=>generate();

// Hard-burn export with ffmpeg.wasm
async function exportVideo(file,groups){
  log('Exporting MP4 with captions... (this may take a while)');
  const { createFFmpeg, fetchFile } = FFmpeg;const ffmpeg=createFFmpeg({log:true});await ffmpeg.load();
  ffmpeg.FS('writeFile','input.mp4',await fetchFile(file));
  const filter=groups.map(g=>{
    const safe=g.text.replace(/'/g,"\\'").replace(/:/g,"\\:"); // escape text
    return `drawtext=text='${safe}':fontcolor=white:fontsize=40:borderw=3:enable='between(t,${g.start},${g.end})':x=(w-text_w)/2:y=h-(text_h*3)`;
  }).join(",");
  await ffmpeg.run('-i','input.mp4','-vf',filter,'-c:a','copy','out.mp4');
  const data=ffmpeg.FS('readFile','out.mp4');const url=URL.createObjectURL(new Blob([data.buffer],{type:'video/mp4'}));
  const a=document.createElement('a');a.href=url;a.download='captioned.mp4';a.click();
  log('ðŸŽ‰ Export complete!');
}
</script>
</body>
</html>
