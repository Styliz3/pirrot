<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Clipscribe AI â€” Auto Subtitles for Shorts</title>
  <link rel="icon" href="data:," />
  <style>
    :root { --bg:#0b0b0d;--panel:#121216;--text:#e8e8f0;--muted:#9aa0aa;--brand:#8a7bff; }
    body{margin:0;background:#0b0b0d;color:var(--text);font:15px Inter,system-ui,sans-serif}
    header{display:flex;justify-content:space-between;align-items:center;padding:20px}
    .btn{padding:10px 16px;border-radius:12px;background:var(--brand);color:#fff;border:none;cursor:pointer;font-weight:600}
    .wrap{display:grid;grid-template-columns:360px 1fr;gap:20px;padding:20px}
    .card{background:#121216;border-radius:12px;padding:16px}
    .player{position:relative;aspect-ratio:9/16;background:#000;border-radius:12px;overflow:hidden}
    video{width:100%;height:100%;object-fit:contain}
    .captions{position:absolute;bottom:8%;width:100%;text-align:center;color:#fff;font-family:Impact,sans-serif;font-size:32px;font-weight:800;text-shadow:2px 2px 0 #000,-2px -2px 0 #000,0 0 10px #000}
    .captions .em{color:#ffe46b}
    .timeline{margin-top:12px;max-height:200px;overflow-y:auto;font-size:14px}
    .timeline div{margin-bottom:6px;padding:4px 6px;border-radius:6px;background:#1a1a1a}
    pre{font-size:12px;color:var(--muted);white-space:pre-wrap}
  </style>
  <!-- FIX: Use UMD build -->
  <script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.15.0/dist/transformers.umd.min.js"></script>
  <!-- ffmpeg.wasm for export -->
  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js"></script>
</head>
<body>
  <header>
    <b>Clipscribe AI</b>
    <button class="btn" onclick="document.getElementById('file').click()">Upload Video</button>
  </header>

  <main class="wrap">
    <div class="card">
      <input id="file" type="file" accept="video/*" style="display:none" />
      <label>Words per subtitle</label>
      <select id="wordsPer"><option value="1">1</option><option value="3" selected>3</option></select>
      <label>Emphasize every</label>
      <select id="emEvery"><option value="0">None</option><option value="3">3rd</option><option value="5">5th</option></select>
      <div style="margin-top:12px;display:flex;gap:10px">
        <button id="go" class="btn">Generate</button>
        <button id="downloadVTT" class="btn" disabled>Download .vtt</button>
        <button id="export" class="btn" disabled>Export MP4</button>
      </div>
      <pre id="log"></pre>
    </div>
    <div class="card">
      <div class="player">
        <video id="video" controls></video>
        <div class="captions" id="caption"></div>
      </div>
      <div class="timeline" id="timeline"></div>
    </div>
  </main>

<script>
const fileEl=document.getElementById('file'), videoEl=document.getElementById('video'), captionEl=document.getElementById('caption');
const wordsPerEl=document.getElementById('wordsPer'), emEveryEl=document.getElementById('emEvery');
const goBtn=document.getElementById('go'), dlBtn=document.getElementById('downloadVTT'), expBtn=document.getElementById('export');
const logEl=document.getElementById('log'), tlEl=document.getElementById('timeline');
let cues=[], lastURL;

function log(m){ logEl.textContent+="\\n"+m; }

fileEl.onchange=()=>{const f=fileEl.files?.[0];if(!f)return;if(lastURL)URL.revokeObjectURL(lastURL);lastURL=URL.createObjectURL(f);videoEl.src=lastURL;log('Video loaded.');};

async function decodeToMono16k(file){const ab=await file.arrayBuffer();const ctx=new AudioContext();const buf=await ctx.decodeAudioData(ab.slice(0));
const off=new OfflineAudioContext(1,Math.ceil(buf.duration*16000),16000);const mono=off.createBuffer(1,buf.length,buf.sampleRate);const ch0=buf.getChannelData(0);
if(buf.numberOfChannels===1)mono.copyToChannel(ch0,0);else{const ch1=buf.getChannelData(1),m=mono.getChannelData(0);for(let i=0;i<buf.length;i++)m[i]=.5*(ch0[i]+ch1[i]);}
const src=off.createBufferSource();src.buffer=mono;src.connect(off.destination);src.start();const rendered=await off.startRendering();return rendered.getChannelData(0);}

function groupWords(words,n){const g=[];for(let i=0;i<words.length;i+=n){const s=words.slice(i,i+n);g.push({text:s.map(w=>w.word).join(' '),start:s[0].start,end:s[s.length-1].end})}return g;}

function attachOverlay(groups,every){cues=groups;videoEl.ontimeupdate=()=>{const t=videoEl.currentTime;const c=cues.find(x=>t>=x.start&&t<=x.end);
if(!c){captionEl.innerHTML='';return;}if(every>0){captionEl.innerHTML=c.text.split(/\\s+/).map((w,i)=>((i+1)%every===0?`<span class='em'>${w}</span>`:w)).join(' ');}else captionEl.textContent=c.text;}}

function renderTimeline(groups){tlEl.innerHTML='';groups.forEach((g,i)=>{const d=document.createElement('div');d.textContent=`${g.start.toFixed(1)}s - ${g.end.toFixed(1)}s: ${g.text}`;tlEl.appendChild(d);});}

let asr;async function ensure(){if(asr)return asr;log('Loading model...');const {pipeline}=window.transformers;asr=await pipeline('automatic-speech-recognition','Xenova/whisper-tiny.en');log('Model ready.');return asr;}

async function generate(){const f=fileEl.files?.[0];if(!f){alert('Pick a video');return;}goBtn.disabled=true;dlBtn.disabled=true;expBtn.disabled=true;captionEl.textContent='';log('Decoding audio...');const audio=await decodeToMono16k(f);
log('Transcribing...');const model=await ensure();const out=await model(audio,{chunk_length_s:25,stride_length_s:5,return_timestamps:true});const words=[];(out.segments||[]).forEach(s=>(s.words||[]).forEach(w=>{if(w.start!==undefined)words.push({word:w.word.trim(),start:w.start,end:w.end})}));
if(!words.length){log('No words detected.');return;}
const groups=groupWords(words,parseInt(wordsPerEl.value));attachOverlay(groups,parseInt(emEveryEl.value));renderTimeline(groups);
const vtt='WEBVTT\\n\\n'+groups.map((g,i)=>`${i+1}\\n00:00:${g.start.toFixed(3)} --> 00:00:${g.end.toFixed(3)}\\n${g.text}\\n`).join('\\n');const blob=new Blob([vtt],{type:'text/vtt'});const url=URL.createObjectURL(blob);
dlBtn.disabled=false;dlBtn.onclick=()=>{const a=document.createElement('a');a.href=url;a.download='captions.vtt';a.click();};
expBtn.disabled=false;expBtn.onclick=()=>exportVideo(f,groups);
log('âœ… Done!');goBtn.disabled=false;}

goBtn.onclick=()=>generate();

// Hard-burn export (ffmpeg.wasm overlay text)
async function exportVideo(file,groups){
  log('Exporting MP4 with captions... (this may take a while)');
  const { createFFmpeg, fetchFile } = FFmpeg; const ffmpeg = createFFmpeg({ log: true }); await ffmpeg.load();
  ffmpeg.FS('writeFile','input.mp4',await fetchFile(file));
  const filter=groups.map(g=>`drawtext=text='${g.text.replace(/'/g,\"\\\\'\")}' :fontcolor=white:fontsize=40:borderw=3:enable='between(t,${g.start},${g.end})':x=(w-text_w)/2:y=h-(text_h*2)`).join(\",\");
  await ffmpeg.run('-i','input.mp4','-vf',filter,'-c:a','copy','out.mp4');
  const data=ffmpeg.FS('readFile','out.mp4');const url=URL.createObjectURL(new Blob([data.buffer],{type:'video/mp4'}));
  const a=document.createElement('a');a.href=url;a.download='captioned.mp4';a.click();
  log('ðŸŽ‰ Export complete!');
}
</script>
</body>
</html>
