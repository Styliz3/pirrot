<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Olida â€” AI Assistant</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #fff; --fg: #111; --muted: #666;
      --accent: #111; --outline: 1px solid #ddd;
      --radius: 12px;
    }
    [data-theme="dark"] {
      --bg: #111; --fg: #eee; --muted: #aaa;
      --accent: #eee; --outline: 1px solid #333;
    }
    body {
      margin:0; font-family: Inter, sans-serif;
      display:grid; grid-template-columns: 260px 1fr;
      height:100vh; background: var(--bg); color: var(--fg);
    }
    /* Sidebar */
    .sidebar {
      border-right: var(--outline);
      display:flex; flex-direction:column;
      background: var(--bg); padding:12px;
    }
    .sidebar h2 { font-size:16px; margin:8px 0; }
    .chat-list { flex:1; overflow-y:auto; }
    .chat-item {
      padding:10px; border-radius: var(--radius);
      cursor:pointer; margin-bottom:6px;
    }
    .chat-item.active { background: var(--accent); color: var(--bg); }
    .btn { padding:8px 12px; border: var(--outline); border-radius: var(--radius); background: var(--bg); cursor:pointer; }
    .btn:hover { opacity:0.8; }
    /* Main */
    .main { display:flex; flex-direction:column; height:100vh; }
    .topbar {
      padding:12px; border-bottom: var(--outline);
      display:flex; justify-content:space-between; align-items:center;
    }
    .chat {
      flex:1; overflow-y:auto; padding:20px;
      display:flex; flex-direction:column; gap:14px;
    }
    .msg { max-width:70%; padding:12px 14px; border-radius: var(--radius); line-height:1.5; white-space:pre-wrap; }
    .msg.user { align-self:flex-end; background:#eaeaea; }
    [data-theme="dark"] .msg.user { background:#333; }
    .msg.ai { align-self:flex-start; background:#fdfdfd; border: var(--outline); }
    [data-theme="dark"] .msg.ai { background:#1a1a1a; }
    .input-bar {
      display:flex; padding:12px; border-top: var(--outline); gap:10px;
    }
    textarea {
      flex:1; padding:12px; border-radius: var(--radius); border: var(--outline);
      resize:none; font:inherit; background:var(--bg); color:var(--fg);
    }
    button { padding:12px 18px; border-radius: var(--radius); border: var(--outline); background: var(--bg); color: var(--fg); cursor:pointer; }
  </style>
</head>
<body data-theme="light">
  <div class="sidebar">
    <h2>Olida</h2>
    <button class="btn" id="newChat">+ New Chat</button>
    <div class="chat-list" id="chatList"></div>
    <button class="btn" id="themeToggle">Toggle Theme</button>
  </div>
  <div class="main">
    <div class="topbar">
      <div id="chatTitle">New Chat</div>
    </div>
    <div class="chat" id="chat"></div>
    <div class="input-bar">
      <textarea id="input" rows="1" placeholder="Type a message..."></textarea>
      <button id="send">Send</button>
    </div>
  </div>

  <script>
    const chat = document.getElementById("chat");
    const input = document.getElementById("input");
    const sendBtn = document.getElementById("send");
    const chatList = document.getElementById("chatList");
    const chatTitle = document.getElementById("chatTitle");

    let chats = JSON.parse(localStorage.getItem("olida_chats")||"[]");
    let activeId = null;

    function save(){ localStorage.setItem("olida_chats", JSON.stringify(chats)); }

    function newChat(){
      const id = Date.now().toString();
      chats.unshift({id, title:"New Chat", messages:[
        { role:"system", content:"You are Olida, a professional AI assistant." }
      ]});
      activeId = id; save(); renderChats(); renderActive();
    }

    function renderChats(){
      chatList.innerHTML="";
      chats.forEach(c=>{
        const div = document.createElement("div");
        div.className="chat-item"+(c.id===activeId?" active":"");
        div.textContent=c.title;
        div.onclick=()=>{ activeId=c.id; renderChats(); renderActive(); save(); };
        chatList.appendChild(div);
      });
    }

    function renderActive(){
      const c = chats.find(x=>x.id===activeId); if(!c) return;
      chat.innerHTML="";
      chatTitle.textContent=c.title;
      c.messages.filter(m=>m.role!=="system").forEach(m=>{
        addMessage(m.role==="assistant"?"ai":"user", m.content);
      });
    }

    function addMessage(role, content){
      const div = document.createElement("div");
      div.className="msg "+role; div.textContent=content;
      chat.appendChild(div); chat.scrollTop=chat.scrollHeight;
    }

    async function send(){
      const text = input.value.trim();
      if (!text) return;
      input.value="";
      const c = chats.find(x=>x.id===activeId); if(!c) return;

      c.messages.push({role:"user", content:text});
      addMessage("user", text); save();

      const res = await fetch("/api/chat", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ messages:c.messages })
      });
      const data = await res.json();
      const reply = data.choices?.[0]?.message?.content || "(no reply)";
      c.messages.push({role:"assistant", content:reply});
      addMessage("ai", reply); save();

      // update chat title from first user msg
      if(c.title==="New Chat"){ c.title = text.slice(0,20); renderChats(); save(); }
    }

    sendBtn.onclick=send;
    input.addEventListener("keydown", e=>{
      if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); send(); }
    });

    document.getElementById("newChat").onclick=newChat;
    document.getElementById("themeToggle").onclick=()=>{
      document.body.dataset.theme = document.body.dataset.theme==="light"?"dark":"light";
    };

    if(chats.length===0){ newChat(); } else { activeId=chats[0].id; renderChats(); renderActive(); }
  </script>
</body>
</html>
