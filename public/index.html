<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Steal a Brainrot — Checkout</title>
<style>
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:#0b1117; color:#e6f0ff }
  .wrap { max-width: 720px; margin: 32px auto; padding: 0 16px }
  .card { background:#0f1720; border:1px solid rgba(148,163,184,.2); border-radius:14px; padding:16px }
  label { display:block; margin:10px 0 6px; color:#a7b3c4; font-size:14px }
  input, select { width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(148,163,184,.25); background:rgba(2,8,23,.5); color:#e6f0ff; outline:none }
  input:focus, select:focus { border-color:#22d3ee; box-shadow:0 0 0 6px rgba(34,211,238,.25) }
  .row { display:grid; grid-template-columns: 1fr 120px; gap:12px; margin-top:8px }
  .summary { margin-top:10px; color:#a7b3c4 }
  h1 { margin:0 0 12px; font-size:22px }
  .price { font-weight:800 }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Tralalita tralala（100K/s） — <span class="price">€3 / $3</span></h1>
      <label>Roblox username</label>
      <input id="username" placeholder="e.g. Styliz3_22" />

      <label>Email for updates</label>
      <input id="email" type="email" placeholder="you@example.com" />

      <div class="row">
        <div>
          <label>Currency</label>
          <select id="currency">
            <option value="EUR">EUR (€)</option>
            <option value="USD">USD ($)</option>
          </select>
        </div>
        <div>
          <label>Quantity</label>
          <input id="qty" type="number" min="1" value="1" />
        </div>
      </div>

      <div class="summary" id="summary">Total €3</div>

      <!-- PayPal buttons get injected here -->
      <div id="paypal-button-container" style="margin-top:14px"></div>
      <small class="summary">You’ll complete payment on PayPal. We don’t store card data.</small>
    </div>
  </div>

  <!-- Loads PayPal SDK with your client-id from the server -->
  <script src="/api/sdk.js"></script>

  <script>
    const usernameEl = document.getElementById('username');
    const emailEl = document.getElementById('email');
    const currencyEl = document.getElementById('currency');
    const qtyEl = document.getElementById('qty');
    const summaryEl = document.getElementById('summary');

    function unitPrice(ccy){ return 3; } // €3 / $3
    function updateSummary(){
      const c = currencyEl.value;
      const q = Math.max(1, Number(qtyEl.value||1));
      const total = unitPrice(c) * q;
      summaryEl.textContent = `Total ${c==='EUR'?'€':'$'}${total}`;
    }
    qtyEl.addEventListener('input', updateSummary);
    currencyEl.addEventListener('change', updateSummary);
    updateSummary();

    // Called by sdk.js after the PayPal SDK finishes loading
    window.initPayPalButtons = function(){
      paypal.Buttons({
        style: { layout:'vertical', shape:'pill' },

        createOrder: async () => {
          const username = usernameEl.value.trim();
          const email = emailEl.value.trim();
          if(!username) { alert('Enter your Roblox username'); return false; }
          if(!/^\S+@\S+\.\S+$/.test(email)) { alert('Enter a valid email'); return false; }

          const res = await fetch('/api/paypal/create-order', {
            method: 'POST',
            headers: { 'Content-Type':'application/json' },
            body: JSON.stringify({
              currency: currencyEl.value,
              items: [{ sku:'tralalita-100kps', qty: Math.max(1, Number(qtyEl.value||1))}],
              meta: { username, email }
            })
          });
          const data = await res.json();
          if(!res.ok){ alert(data.error || 'Failed to create order'); return false; }
          return data.id;
        },

        onApprove: async (data) => {
          const res = await fetch('/api/paypal/capture-order', {
            method: 'POST',
            headers: { 'Content-Type':'application/json' },
            body: JSON.stringify({ orderId: data.orderID })
          });
          const out = await res.json();
          if(!res.ok){ alert(out.error || 'Capture failed'); return; }
          alert('Payment successful! We will deliver shortly.');
        },

        onError: (err) => {
          console.error(err);
          alert('Payment error. Please try again.');
        }
      }).render('#paypal-button-container');
    };
  </script>
</body>
</html>
